!function(a){"use strict";var t=Util.dataProcess,s="ontouchstart"in document?"tap":"click",r={isDebug:!1,container:"#pullrefresh",listContainer:"#listdata",type:"POST",initPageIndex:0,pageSize:10,url:null,template:"#item-template",dataRequest:null,dataChange:null,itemClick:null,success:null,error:null,refresh:null,isAutoRender:!0,itemSelector:"li",delay:0,timeout:6e3,accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:null,setting:{down:{isSuccessTips:!0},up:{auto:!0}}};function e(e){var t,i=this,s=(e=a.extend(!0,{},r,e)).template;!("string"==typeof s&&/^[.#]/.test(s)||s instanceof HTMLElement)||(t=a.selector(s))&&(s=t.innerHTML.toString()||""),e.template=s;var n=null;switch(e.skin){case"type1":n=PullToRefreshTools.skin.type1;break;case"type2":n=PullToRefreshTools.skin.type2;break;case"type3":n=PullToRefreshTools.skin.type3;break;case"type4":n=PullToRefreshTools.skin.type4;break;case"type5":n=PullToRefreshTools.skin.type5;break;case"native":n=PullToRefreshTools.skin.native;break;default:n=PullToRefreshTools.skin.defaults}if(!n)throw new Error("错误:传入的下拉刷新皮肤错误,超出范围!");var o=e.setting;o.container=e.container,o.down&&(o.down.callback=function(){i._pullDownCallback()}),o.up&&(o.up.callback=function(){i._pullUpCallback()}),this.container=a.selector(e.container),this.listContainer=a.selector(e.listContainer),this.options=e,this.setting=o,this._initParams(),this.instance=new n(o),this._addEvent()}e.prototype={_initParams:function(){this.isShouldNoMoreData=!0,this.currPage=this.options.initPageIndex,this.setting.up&&this.setting.up.auto&&this.currPage--},_pullDownCallback:function(){var e=this,t=this.options;this.loadingDown||(this.isPullDown=!0,this.loadingDown=!0,this.currPage=t.initPageIndex,setTimeout(function(){e._ajaxRequest()},t.delay),t.refresh&&t.refresh(!0))},_pullUpCallback:function(){var e=this;this.loadingUp||(this.isPullDown=!1,this.loadingUp=!0,this.currPage++,setTimeout(function(){e._ajaxRequest()},this.options.delay))},_clearResponseEl:function(){this.options.isAutoRender&&this.listContainer&&(this.listContainer.innerHTML="")},_render:function(e){var t=this.options,i=0;if(t.isAutoRender)if(this.isPullDown&&this._clearResponseEl(),window.Mustache)if(e&&Array.isArray(e)&&0<e.length){for(var s="",n=0,o=e.length;n<o;n++){var a=e[n],r="";t.template&&("string"==typeof t.template?r=t.template:"function"==typeof t.template&&(r=t.template(a))),s+=Mustache.render(r,a),i++}""!=s&&this.listContainer.appendChild(function(e){if(null==e||"string"!=typeof e)return null;var t,i=document.createElement("div"),s=document.createDocumentFragment();for(i.innerHTML=e;t=i.firstChild;)s.appendChild(t);return s}(s))}else this.isShouldNoMoreData=!1;else this.isShouldNoMoreData=!1,t.isDebug&&console.error("error***没有包含mustache文件,无法进行模板渲染");return i},_dataChangeDefault:function(e){return t(e,{dataPath:["custom.infoList","custom.list","UserArea.InfoList"]}).data},_ajaxRequest:function(){var i=this,s=this.options;if(!s.url)return s.isDebug&&console.error("error***url无效,无法访问"),void this._errorRequest(null,null,"请求url为空!");function t(e){var t="",t="function"==typeof s.url?s.url():s.url;Util.ajax({url:t,data:e,dataType:"json",timeout:s.timeout,type:s.type,accepts:s.accepts,headers:s.headers,contentType:s.contentType,success:function(e){i._successRequest(e)},error:function(e,t){i._errorRequest(e,t,"请求失败!")}})}var e;s.dataRequest?void 0!==(e=s.dataRequest(this.currPage,function(e){t(e)}))&&t(e):(s.isDebug&&console.warn("warning***请注意dataRequest不存在,默认数据为空"),t())},_errorRequest:function(e,t,i){var s=this.options;this.isShouldNoMoreData=!1,this._refreshState(!1),this.currPage--,this.currPage=this.currPage>=s.initPageIndex?this.currPage:s.initPageIndex,s.error&&s.error(e,t,i)},_successRequest:function(e){var t=this.options;if(!e)return t.isDebug&&console.log("warning***返回的数据为空,请注意！"),this.isShouldNoMoreData=!1,void this._refreshState(!1);t.isDebug&&console.log("下拉刷新返回数据:"+JSON.stringify(e)),e=t.dataChange?t.dataChange(e):this._dataChangeDefault(e);var i=this._render(e);this.loadingMoreSuccess&&(this.loadingMoreSuccess(),this.loadingMoreSuccess=null),t.success&&"function"==typeof t.success&&t.success(e,this.isPullDown||this.currPage==t.initPageIndex),this._refreshState(!0,i)},_refreshState:function(e,t){var i=this.instance;t=t||0,i.setSuccessTips&&i.setSuccessTips("更新"+t+"条数据"),this.isPullDown&&(i.endPullDownToRefresh(e),i.finished&&(i.refresh(!0),this.isShouldNoMoreData=!0)),this.isShouldNoMoreData?i.endPullUpToRefresh(!1,e):i.endPullUpToRefresh(!0,e),this.loadingDown=!1,this.loadingUp=!1},_addEvent:function(){var e=this.listContainer,t=this.options,i=t.itemClick;"function"==typeof i&&mui(e).on(s,t.itemSelector,i)},refresh:function(){var e=this.options;e.up&&this.instance.enablePullUp?this.loadingUp||(this._clearResponseEl(),this.currPage=e.initPageIndex-1,this.loadingMore()):(this._clearResponseEl(),this._pullDownCallback())},loadingMore:function(e){var t=this.instance;this.loadingMoreSuccess=e,this.instance.finished&&(this.instance.refresh(!0),this.isShouldNoMoreData=!0),t.pullupLoading()},disablePullupToRefresh:function(){this.pullToRefreshInstance.disablePullupToRefresh()},enablePullupToRefresh:function(){this.pullToRefreshInstance.enablePullupToRefresh()},destroy:function(){mui(listContainer).off(),this.container=null,this.listContainer=null,this.instance=null,this.options=null}},a.namespace("bizlogic",e)}(PullToRefreshTools);